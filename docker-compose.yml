version: '3'

services:
  znca-api:
    build: .
    command:
      - android-frida-server
      - $ZNCA_API_ANDROID_DEVICE
      - --exec-command
      - ${ZNCA_API_EXEC_COMMAND:-}
      # - --adb-root
      - --frida-server-path
      - ${ZNCA_API_FRIDA_SERVER_PATH:-/data/local/tmp/frida-server}
      - --start-method
      - ${ZNCA_API_APP_START_METHOD:-spawn}
      - --health-secret
      - ${ZNCA_API_HEALTH_SECRET:-}
      - --listen
      - '[::]:80'
    restart: unless-stopped
    depends_on:
      - web
    labels:
      traefik.enable: true
      traefik.http.routers.nxapi-znca.entrypoints: websecure
      traefik.http.routers.nxapi-znca.rule: Host(`${TRAEFIK_HOST:-nxapi.ta.fancy.org.uk}`) && PathPrefix(`/api/znca/`)
      traefik.http.routers.nxapi-znca.tls: true
      traefik.http.services.nxapi-znca.loadbalancer.server.port: 80
    environment:
      DEBUG: '*,-express:*,-body-parser:*'
    volumes:
      - data:/data
    healthcheck:
      test: [ "ENTRYPOINT", "curl", "http://[::1]:80/api/znca/health" ]
      timeout: 45s
      interval: 10s
      retries: 10

volumes:
  data:
